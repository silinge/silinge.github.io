<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>离线3D地图演示</title>
    <link href="https://cdn.jsdelivr.net/npm/cesium@1.113.0/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
    </style>
</head>
<body>
    <div style="position:absolute;top:0;left:0;width:100%;background:yellow;color:#333;padding:8px 0;z-index:10000;text-align:center;font-weight:bold;font-size:16px;">
        注意：请务必通过本地HTTP服务器（如 python -m http.server）访问本页面，否则地图瓦片无法加载！
    </div>
    <div id="cesiumContainer"></div>
    <div id="errorMsg" style="position:absolute;top:10px;left:10px;color:red;z-index:9999;"></div>
    <script src="https://cdn.jsdelivr.net/npm/cesium@1.113.0/Build/Cesium/Cesium.js"></script>
    <script>
        // 检查Cesium是否加载
        if (!window.Cesium) {
            document.getElementById('errorMsg').innerText = 'Cesium.js 加载失败！';
        } else {
            // 检查本地瓦片目录是否存在
            function checkTileExists(url, callback) {
                var xhr = new XMLHttpRequest();
                xhr.open('HEAD', url);
                xhr.onload = function() {
                    callback(xhr.status === 200);
                };
                xhr.onerror = function() {
                    callback(false);
                };
                xhr.send();
            }

            // 测试0级瓦片是否存在
            checkTileExists('./tiles/0/0/0.png', function(exists) {
                if (!exists) {
                    document.getElementById('errorMsg').innerText = '未检测到 ./tiles/0/0/0.png，请确认本地瓦片目录和文件存在。';
                }
            });

            // 初始化Cesium Viewer
            const viewer = new Cesium.Viewer('cesiumContainer', {
                imageryProvider: new Cesium.UrlTemplateImageryProvider({
                    url: './tiles/{z}/{x}/{y}.png', // 本地瓦片路径
                    maximumLevel: 18,
                    minimumLevel: 0,
                    tileWidth: 256,
                    tileHeight: 256,
                    tilingScheme: new Cesium.WebMercatorTilingScheme(),
                    credit: '© OpenStreetMap contributors'
                }),
                baseLayerPicker: false,
                geocoder: false,
                homeButton: true,
                sceneModePicker: true,
                timeline: false,
                animation: false,
                navigationHelpButton: false,
                infoBox: false,
                fullscreenButton: true,
                shouldAnimate: true
            });

            // 可选：设置初始视角
            viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(116.397128, 39.916527, 15000) // 北京天安门
            });

            // 打印viewer对象，便于调试
            console.log('Cesium Viewer:', viewer);

            // 检查瓦片加载情况
            viewer.imageryLayers.layerAdded.addEventListener(function(layer) {
                layer.errorEvent.addEventListener(function(error) {
                    document.getElementById('errorMsg').innerText = '瓦片加载失败，请检查 ./tiles 目录是否存在有效瓦片。\n' + error.message;
                });
            });

            // 可选：添加Cesium自带底图用于排查
            // viewer.imageryLayers.addImageryProvider(new Cesium.BingMapsImageryProvider({
            //     url: 'https://dev.virtualearth.net',
            //     key: '', // 可选，Bing地图key
            //     mapStyle: Cesium.BingMapsStyle.AERIAL
            // }));

        }
    </script>
</body>
</html>
